name: Deploy Fullstack App (Frontend + Backend + Lambdas)

on:
  push:
    branches: [ "main" ]

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:

 backend:
  runs-on: ubuntu-latest
  
  env:
    AWS_REGION: us-east-1
    AWS_DEFAULT_REGION: us-east-1

  steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    # ZIP Lambda API
    - name: Crear zip lambda_api
      working-directory: infra/lambda/lambda_api
      run: zip -r ${{ github.workspace }}/lambda_api.zip .

    - name: Subir Lambda API
      run: |
        aws lambda update-function-code \
          --function-name InfraStack-SpaceXApiLambdaD2EA4341-hpLHExsea8DU \
          --zip-file fileb://${{ github.workspace }}/lambda_api.zip \
          --region us-east-1

    # ZIP Lambda IMPORT
    - name: Crear zip lambda_import
      working-directory: infra/lambda/lambda_import
      run: zip -r ${{ github.workspace }}/lambda_import.zip .

    - name: Subir Lambda Import
      run: |
        aws lambda update-function-code \
          --function-name InfraStack-SpaceXImportLambda2D0521AC-xHcGSl9T3DDu \
          --zip-file fileb://${{ github.workspace }}/lambda_import.zip \
          --region us-east-1


  # ===========================================
  # ================ FRONTEND ==================
  # ===========================================
  frontend:
    runs-on: ubuntu-latest
    needs: backend   # IMPORTANTE: primero backend, luego frontend

    env:
      AWS_REGION: us-east-2          # ECS y ECR del frontend est√°n en Ohio
      ECR_REPO: spacex-frontend
      IMAGE_TAG: latest
      AWS_DEFAULT_REGION: us-east-2

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Login a ECR
        run: |
          aws ecr get-login-password --region us-east-2 | docker login \
            --username AWS \
            --password-stdin 986518320161.dkr.ecr.us-east-2.amazonaws.com

      - name: Build Docker frontend
        working-directory: spacex-frontend
        run: |
          docker build -t spacex-frontend .

      - name: Tag Docker image
        run: |
          docker tag spacex-frontend:latest \
            986518320161.dkr.ecr.us-east-2.amazonaws.com/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

      - name: Push Docker image to ECR
        run: |
          docker push \
            986518320161.dkr.ecr.us-east-2.amazonaws.com/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster spacex-cluster \
            --service spacex-service \
            --force-new-deployment \
            --region us-east-2
